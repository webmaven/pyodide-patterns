<!DOCTYPE html>
<html>
<head>
    <script src="../js/sw_registration.js?v=6.0.0"></script>
    <title>Python UI Offloading Pattern</title>
    <!-- Atomic Bootstrapper -->
    <script src="../js/atomic_bootstrap.js?v=6.0.0"></script>
    <style>
        .spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <h1>Python-Centric UI Offloading</h1>
    <p>This page uses Python for <strong>both</strong> UI logic and heavy computation.</p>
    
    <div style="border: 1px solid #ccc; padding: 20px; border-radius: 8px;">
        <div style="display: flex; align-items: center; margin-bottom: 10px;">
            <div id="ui-spinner" class="spinner hidden"></div>
            <p id="ui-status" style="margin: 0;">Initial bootstrap...</p>
        </div>
        <button id="process-btn" disabled>Run Background Python (3s)</button>
        <p>Result: <strong id="ui-output">None</strong></p>
    </div>

    <script src="../js/pyodide_loader.js"></script>
    
    <script>
        function log(msg) {
            console.log(`[${new Date().toISOString()}] [Demo v6.0.0] ${msg}`);
        }

        async function init() {
            const status = document.getElementById('ui-status');
            log("Initialization started.");
            
            status.textContent = "Verifying isolation shield...";
            if (!(await window.waitForShield())) {
                status.textContent = "Shield failed to activate. Please refresh.";
                return;
            }

            try {
                status.textContent = "Setting up atomic background worker...";
                
                // ATOMIC SHIELD PATTERN:
                // We provide the worker logic as a string. 
                // spawnIsolatedWorker handles the dependency injection and Blob creation.
                const workerLogic = `
                    (async function() {
                        try {
                            class PyodideWorker {
                                async init() {
                                    this.pyodide = await loadPyodide({
                                        indexURL: "./examples/vendor/"
                                    });
                                }
                                async runPython(code) {
                                    return await this.pyodide.runPythonAsync(code);
                                }
                            }
                            Comlink.expose(new PyodideWorker());
                        } catch (e) {
                            self.postMessage({ type: 'error', message: e.message });
                        }
                    })();
                `;

                log("Spawning atomic worker...");
                const worker = await window.spawnIsolatedWorker(workerLogic);
                
                worker.onerror = (e) => {
                    console.error("FATAL Worker Error:", e);
                    status.textContent = "Worker Error: Thread died (Check COEP/CORP)";
                };

                window.worker_bridge = Comlink.wrap(worker);
                await window.worker_bridge.init();
                log("Worker bridge ready.");

                // 2. Setup the Main Thread Pyodide
                status.textContent = "Bootstrapping main thread Python...";
                const pyodide = await loadPyodideAndFiles(['ui_controller.py']);
                log("Main thread Pyodide ready.");
                
                // 3. Import and Run the Python UI Logic
                status.textContent = "Loading Python UI Controller...";
                await pyodide.runPythonAsync("from pyodide_app import ui_controller");
                log("UI Controller loaded.");
                
                document.getElementById('process-btn').disabled = false;
            } catch (err) {
                console.error("Demo Error:", err);
                status.textContent = "Error: " + err.message;
            }
        }

        init();
    </script>
</body>
</html>
