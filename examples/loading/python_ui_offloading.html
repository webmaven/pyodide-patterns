<!DOCTYPE html>
<html>
<head>
    <script src="../js/sw_registration.js"></script>
    <title>Python UI Offloading Pattern</title>
    <script src="https://cdn.jsdelivr.net/npm/comlink/dist/umd/comlink.js" crossorigin></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.28.0/full/pyodide.js" crossorigin></script>
    <style>
        .spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <h1>Python-Centric UI Offloading</h1>
    <p>This page uses Python for <strong>both</strong> UI logic and heavy computation.</p>
    
    <div style="border: 1px solid #ccc; padding: 20px; border-radius: 8px;">
        <div style="display: flex; align-items: center; margin-bottom: 10px;">
            <div id="ui-spinner" class="spinner hidden"></div>
            <p id="ui-status" style="margin: 0;">Initial bootstrap...</p>
        </div>
        <button id="process-btn" disabled>Run Background Python (3s)</button>
        <p>Result: <strong id="ui-output">None</strong></p>
    </div>

    <script src="../js/pyodide_loader.js"></script>
    <script>
        function log(msg) {
            console.log(`[${new Date().toISOString()}] Demo: ${msg}`);
        }

        async function init() {
            const status = document.getElementById('ui-status');
            log("Initialization started.");
            
            try {
                // 1. Setup the Worker Bridge (JS side)
                status.textContent = "Setting up background worker...";
                log("Spawning worker...");
                
                // Use absolute path with cache-buster for worker
                const workerUrl = new URL(`../js/comlink_worker.js?v=${Date.now()}`, window.location.href).href;
                log(`Spawning worker from: ${workerUrl}`);
                const worker = new Worker(workerUrl);
                
                worker.onerror = (e) => {
                    console.error(`[${new Date().toISOString()}] FATAL Worker Error:`, {
                        message: e.message,
                        filename: e.filename,
                        lineno: e.lineno,
                        colno: e.colno,
                        error: e.error
                    });
                    status.textContent = "Worker Error: " + (e.message || "Thread died immediately (Check COEP/CORP)");
                };

                window.worker_bridge = Comlink.wrap(worker);
                
                log("Initializing worker bridge (Awaiting worker.init)...");
                await window.worker_bridge.init();
                log("Worker bridge ready.");

                // 2. Setup the Main Thread Pyodide
                status.textContent = "Bootstrapping main thread Python...";
                log("Loading main thread Pyodide and files...");
                const pyodide = await loadPyodideAndFiles(['ui_controller.py']);
                log("Main thread Pyodide ready.");
                
                // 3. Import and Run the Python UI Logic
                status.textContent = "Loading Python UI Controller...";
                log("Importing ui_controller...");
                await pyodide.runPythonAsync("from pyodide_app import ui_controller");
                log("UI Controller loaded.");
                
                document.getElementById('process-btn').disabled = false;
            } catch (err) {
                console.error(`[${new Date().toISOString()}] Demo: Initialization failed:`, err);
                status.textContent = "Error: " + err.message;
            }
        }

        log(`Initial Check - Isolated: ${window.crossOriginIsolated}, SW: ${!!navigator.serviceWorker.controller}`);
        
        // Always try to initialize, but warn if not isolated
        if (!window.crossOriginIsolated) {
            log("WARNING: Page is NOT isolated. Worker might fail if it loads from CDN.");
        }
        
        init();
    </script>
</body>
</html>
