<!DOCTYPE html>
<html>

<head>
    <script src="../js/sw_registration.js?v=2.3.5"></script>
    <title>DataCloneError Test</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.28.0/full/pyodide.js" crossorigin></script>
</head>

<body>
    <h1>DataCloneError Test</h1>
    <p id="status">Loading Pyodide on main thread...</p>
    <script>
        const status = document.getElementById('status');
        // A very simple worker that does nothing but receive messages.
        const worker = new Worker('../js/simple_worker.js');

        async function main() {
            const pyodide = await loadPyodide();
            status.textContent = 'Pyodide loaded. Creating Python object...';

            // Create a simple Python object (a dictionary).
            // This returns a PyProxy to the JavaScript side.
            const pyProxy = pyodide.runPython("({'a': 1})");

            status.textContent = 'Attempting to post PyProxy to worker...';
            try {
                // This is the line that will throw the DataCloneError.
                worker.postMessage(pyProxy);
                status.textContent = 'This should not appear!';
            } catch (e) {
                console.error("Caught expected error:", e);
                status.textContent = `Caught expected error: ${e.name}`;
            }
        }

        main();
    </script>
</body>

</html>